#summary Doug's Notes on EC2
<wiki:toc/>

== EC2 Links ===
  * [http://aws.amazon.com/ec2/ Service Overview]
  * [http://aws.amazon.com/ec2/#pricing Instance Pricing]
  * [http://docs.amazonwebservices.com/AWSEC2/2008-02-01/DeveloperGuide/index.html Instance Types]
  * [http://developer.amazonwebservices.com/connect/kbcategory.jspa?categoryID=101 Public EC2 AMI Directory]
  * [http://docs.amazonwebservices.com/AWSEC2/2008-02-01/DeveloperGuide/index.html Developer's Guide]
  * [https://console.aws.amazon.com/ec2/home Management Console]

== How to Create an EC2 Instance ==

The following steps got me up and running with a machine on EC2.  The following command created the machine instance.  The `ami-5c709435` parameter refers to a public AMI.  Check out the [http://developer.amazonwebservices.com/connect/kbcategory.jspa?categoryID=101 Public EC2 AMI Directory] for other images.  The `-k gsg-keypair` argument refers to the keypair generated with a previous run of the command `ec2-add-keypair gsg-keypair`.  See [http://docs.amazonwebservices.com/AWSEC2/latest/GettingStartedGuide/ Amazon EC2 Getting Started Guide] for help getting setup.  I cut and pasted the private key into the file `~/.ec2/id_rsa-gsg-keypair`

{{{
$ ec2-run-instances ami-5c709435 -k gsg-keypair 
RESERVATION               r-9c5aeaf5            724784214682 default
INSTANCE                  i-ccf678a5            ami-5c709435            pending gsg-keypair     0               m1.small 2009-02-03T05:50:57+0000 us-east-1a aki-a71cf9ce ari-a51cf9cc 
}}}

After waiting a bit, I ran the following command to obtain the instance ID and hostname.

{{{
$ ec2-describe-instances 
RESERVATION               r-9c5aeaf5                 724784214682                       default
INSTANCE                  i-ccf678a5                 ami-5c709435                       ec2-75-101-254-105.compute-1.amazonaws.com domU-12-31-38-00-6C-78.compute-1.internal running gsg-keypair 0  m1.small 2009-02-03T05:50:57+0000 us-east-1a aki-a71cf9ce ari-a51cf9cc 
}}}

Copy my account tarball to the machine:

{{{
scp -i .ec2/id_rsa-gsg-keypair ec2/doug-ec2-account.tgz root@ec2-75-101-254-105.compute-1.amazonaws.com:/tmp
}}}

I was then able to log into the system as root without a password with the following comand:

{{{
$ ssh -i .ec2/id_rsa-gsg-keypair root@ec2-75-101-254-105.compute-1.amazonaws.com
}}}

Then, after logging into the machine, setup the doug account:

{{{
# useradd -d /home/doug -s /bin/bash doug
# echo "doug    ALL=(ALL) ALL" >> /etc/sudoers
# mkdir /mnt/hypertable
# chmod a+rwx /mnt/hypertable 
# passwd doug
# su - doug
$ tar xzvf /tmp/doug-bash-account-setup.tgz 
}}}

== Creating a new Image ==

1. Start with an existing AMI
2. Make modifications
3. Run this
{{{
depmod -a; modprobe loop
}}}
4. Bundle the image
{{{
cd ~/.ec2
scp *.pem ec2-67-202-14-246.compute-1.amazonaws.com:~
}}}

Make all modifications to the instance.  Then, as root, execute something like the following:

{{{
# ec2-bundle-vol -k pk-*.pem -c cert-*.pem 724784214682 -u 724784214682 --arch x86_64
}}}